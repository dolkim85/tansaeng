<?php
require_once __DIR__ . '/../../classes/Auth.php';
require_once __DIR__ . '/../../classes/Database.php';

$productId = $_GET['id'] ?? 0;
$error = '';
$product = null;
$relatedProducts = [];
$reviews = [];
$averageRating = 0;

if (!$productId) {
    header('Location: index.php');
    exit;
}

try {
    $auth = Auth::getInstance();
    $currentUser = $auth->getCurrentUser();
    $db = Database::getInstance();
    $pdo = $db->getConnection();

    // Get product details
    $sql = "SELECT p.*, c.name as category_name
            FROM products p
            LEFT JOIN categories c ON p.category_id = c.id
            WHERE p.id = ? AND p.status = 'active'";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$productId]);
    $product = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$product) {
        header('Location: index.php');
        exit;
    }

    // Update view count
    $sql = "UPDATE products SET views = views + 1 WHERE id = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$productId]);

    // Get related products (same category)
    $sql = "SELECT p.*, c.name as category_name
            FROM products p
            LEFT JOIN categories c ON p.category_id = c.id
            WHERE p.category_id = ? AND p.id != ? AND p.status = 'active'
            ORDER BY p.created_at DESC LIMIT 4";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$product['category_id'], $productId]);
    $relatedProducts = $stmt->fetchAll(PDO::FETCH_ASSOC);

} catch (Exception $e) {
    // Use sample data when database is not available
    error_log("Database connection failed in product.php: " . $e->getMessage());
    header('Location: index.php');
    exit;
}

// Process product features
$features = [];
if (!empty($product['features'])) {
    $featuresData = json_decode($product['features'], true);
    if (is_array($featuresData)) {
        $features = $featuresData;
    } else {
        // If not JSON, treat as plain text with newlines
        $features = array_filter(array_map('trim', explode("\n", $product['features'])));
    }
}

// Process product images
$productImages = [];
if (!empty($product['images'])) {
    $imagesData = json_decode($product['images'], true);
    if (is_array($imagesData)) {
        $productImages = $imagesData;
    }
}

// If no specific images, use the main image_url
if (empty($productImages) && !empty($product['image_url'])) {
    $productImages = [$product['image_url']];
}

// If no images, use placeholder
if (empty($productImages)) {
    $productImages = ['/assets/images/product-placeholder.jpg'];
}

// Calculate discount
$hasDiscount = !empty($product['discount_percentage']) && $product['discount_percentage'] > 0;
$finalPrice = $hasDiscount
    ? $product['price'] * (100 - $product['discount_percentage']) / 100
    : $product['price'];

// Get stock quantity
$stockQuantity = $product['stock_quantity'] ?? $product['stock'] ?? 0;

// Get shipping cost
$shippingCost = $product['shipping_cost'] ?? 0;
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= htmlspecialchars($product['name']) ?> - ÌÉÑÏÉù</title>
    <meta name="description" content="<?= htmlspecialchars($product['description'] ?? '') ?>">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/store.css">
    <link rel="stylesheet" href="/assets/css/product-detail.css">
</head>
<body>
    <?php include '../../includes/header.php'; ?>

    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <div class="container">
            <a href="/">Ìôà</a>
            <span class="separator">></span>
            <a href="/pages/store/">Ïä§ÌÜ†Ïñ¥</a>
            <span class="separator">></span>
            <a href="/pages/store/?category=<?= $product['category_id'] ?>"><?= htmlspecialchars($product['category_name'] ?? 'Ïπ¥ÌÖåÍ≥†Î¶¨') ?></a>
            <span class="separator">></span>
            <span class="current"><?= htmlspecialchars($product['name']) ?></span>
        </div>
    </nav>

    <!-- Main Product Section -->
    <main class="product-detail-section">
        <div class="container">
            <div class="product-main">
                <!-- Product Gallery -->
                <div class="product-gallery">
                    <div class="main-image-container">
                        <?php if ($hasDiscount): ?>
                            <div class="image-badge"><?= $product['discount_percentage'] ?>% OFF</div>
                        <?php endif; ?>
                        <img src="<?= htmlspecialchars($productImages[0]) ?>"
                             alt="<?= htmlspecialchars($product['name']) ?>"
                             class="main-image" id="mainImage">
                    </div>

                    <?php if (count($productImages) > 1): ?>
                    <div class="thumbnail-list">
                        <?php foreach ($productImages as $index => $image): ?>
                        <img src="<?= htmlspecialchars($image) ?>"
                             alt="<?= htmlspecialchars($product['name']) ?> Ïù¥ÎØ∏ÏßÄ <?= $index + 1 ?>"
                             class="thumbnail <?= $index === 0 ? 'active' : '' ?>"
                             onclick="changeMainImage('<?= htmlspecialchars($image) ?>', this)">
                        <?php endforeach; ?>
                    </div>
                    <?php endif; ?>
                </div>

                <!-- Product Info -->
                <div class="product-info">
                    <div class="product-header">
                        <h1 class="product-title"><?= htmlspecialchars($product['name']) ?></h1>
                        <div class="product-meta">
                            <div class="meta-item">
                                <span class="rating-stars">
                                    <?= str_repeat('‚≠ê', (int)round($product['rating_score'] ?? 4.5)) ?>
                                </span>
                                <span>(<?= $product['review_count'] ?? 0 ?>)</span>
                            </div>
                            <div class="meta-item">
                                üëÅÔ∏è <?= number_format($product['views'] ?? 0) ?>Ìöå Ï°∞Ìöå
                            </div>
                            <div class="meta-item">
                                üì¶ Ïû¨Í≥†: <?= $product['stock_quantity'] ?? 0 ?>Í∞ú
                            </div>
                        </div>
                    </div>

                    <!-- Price Section -->
                    <div class="price-section">
                        <div class="price-wrapper">
                            <?php if ($hasDiscount): ?>
                                <span class="original-price"><?= number_format($product['price']) ?>Ïõê</span>
                                <span class="current-price"><?= number_format($finalPrice) ?>Ïõê</span>
                                <span class="discount-badge"><?= $product['discount_percentage'] ?>% Ìï†Ïù∏</span>
                            <?php else: ?>
                                <span class="current-price"><?= number_format($product['price']) ?>Ïõê</span>
                            <?php endif; ?>
                        </div>

                        <?php if (!empty($product['delivery_info'])): ?>
                        <div class="delivery-info" style="display: none;">
                            <h4>üöö Î∞∞ÏÜ°Ï†ïÎ≥¥</h4>
                            <div class="delivery-text"><?= htmlspecialchars($product['delivery_info']) ?></div>
                        </div>
                        <?php endif; ?>
                    </div>

                    <!-- Product Description -->
                    <?php if (!empty($product['description'])): ?>
                    <div class="product-description">
                        <?= nl2br(htmlspecialchars($product['description'])) ?>
                    </div>
                    <?php endif; ?>

                    <!-- Features -->
                    <?php if (!empty($features)): ?>
                    <div class="specifications">
                        <h4>üåü Ï£ºÏöî ÌäπÏßï</h4>
                        <ul class="spec-list">
                            <?php foreach ($features as $feature): ?>
                            <li>
                                <span class="spec-label">‚úì</span>
                                <span class="spec-value"><?= htmlspecialchars($feature) ?></span>
                            </li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                    <?php endif; ?>

                    <!-- Purchase Section -->
                    <div class="specifications purchase-inline">
                        <h4>üõí Íµ¨Îß§ÌïòÍ∏∞</h4>

                        <!-- Stock Status -->
                <div id="stockStatus" class="stock-status" data-stock="<?= $stockQuantity ?>">
                    <!-- JavaScriptÎ°ú ÎèôÏ†Å ÏóÖÎç∞Ïù¥Ìä∏ -->
                </div>

                <!-- Quantity and Shipping Section -->
                <div class="quantity-shipping-wrapper">
                    <div class="quantity-section">
                        <label class="quantity-label">ÏàòÎüâ</label>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="changeQuantity(-1)" id="decreaseBtn">-</button>
                            <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="<?= $stockQuantity ?>">
                            <button class="quantity-btn" onclick="changeQuantity(1)" id="increaseBtn">+</button>
                        </div>
                    </div>

                    <div class="shipping-cost-info">
                        <label class="shipping-label">üì¶ Î∞∞ÏÜ°ÎπÑ</label>
                        <div class="shipping-cost-amount">
                            <?php if ($shippingCost > 0): ?>
                                <?= number_format($shippingCost) ?>Ïõê
                            <?php else: ?>
                                <span class="free-shipping">Î¨¥Î£åÎ∞∞ÏÜ°</span>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>

                <!-- Total Price -->
                <div class="total-price">
                    <div class="total-label">Ï¥ù Í∏àÏï°</div>
                    <div class="price-breakdown">
                        <div class="breakdown-item">
                            <span>ÏÉÅÌíàÍ∏àÏï°</span>
                            <span id="productAmount"><?= number_format($finalPrice) ?>Ïõê</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Î∞∞ÏÜ°ÎπÑ</span>
                            <span id="shippingAmount">
                                <?php if ($shippingCost > 0): ?>
                                    <?= number_format($shippingCost) ?>Ïõê
                                <?php else: ?>
                                    Î¨¥Î£å
                                <?php endif; ?>
                            </span>
                        </div>
                        <div class="breakdown-divider"></div>
                        <div class="breakdown-total">
                            <span>Í≤∞Ï†úÍ∏àÏï°</span>
                            <span id="totalAmount"><?= number_format($finalPrice + $shippingCost) ?>Ïõê</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <?php if ($stockQuantity > 0): ?>
                        <button class="btn btn-secondary" onclick="addToCart()">
                            üõí Ïû•Î∞îÍµ¨Îãà
                        </button>
                        <button class="btn btn-primary" onclick="buyNow()">
                            üí≥ Î∞îÎ°úÍµ¨Îß§
                        </button>
                    <?php else: ?>
                        <button class="btn" disabled>
                            ÌíàÏ†àÎêú ÏÉÅÌíàÏûÖÎãàÎã§
                        </button>
                    <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Tabs -->
        <div class="product-tabs">
                <div class="tab-navigation">
                    <button class="tab-btn active" onclick="showTab('description')">ÏÉÅÌíàÏÑ§Î™Ö</button>
                    <button class="tab-btn" onclick="showTab('specs')">ÏÉÅÌíàÏ†ïÎ≥¥</button>
                    <button class="tab-btn" onclick="showTab('reviews')">Î¶¨Î∑∞ (<?= $product['review_count'] ?? 0 ?>)</button>
                    <button class="tab-btn" onclick="showTab('qna')">Î¨∏Ïùò</button>
                </div>

                <!-- Description Tab -->
                <div id="description" class="tab-content active">
                    <h3>üìù ÏÉÅÌíà ÏÉÅÏÑ∏ÏÑ§Î™Ö</h3>
                    <?php if (!empty($product['detailed_description'])): ?>
                        <?php
                        // Ïù¥ÎØ∏ÏßÄ Ìà¥Î∞î Ï†úÍ±∞ Ìï®Ïàò
                        function removeImageToolbars($html) {
                            // image-inline-toolbar div Ï†úÍ±∞
                            $html = preg_replace('/<div class="image-inline-toolbar">.*?<\/div>/s', '', $html);
                            return $html;
                        }
                        $cleanDescription = removeImageToolbars($product['detailed_description']);
                        ?>
                        <div class="product-description-content"><?= $cleanDescription ?></div>
                    <?php else: ?>
                        <div class="product-description-content"><?= nl2br(htmlspecialchars($product['description'] ?? 'ÏÉÅÏÑ∏ ÏÑ§Î™ÖÏù¥ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.')) ?></div>
                    <?php endif; ?>

                    <?php if (!empty($features)): ?>
                    <div class="features-grid">
                        <?php foreach ($features as $index => $feature): ?>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <?= ['üå±', 'üíß', 'üåø', '‚ö°', 'üî¨', 'üå°Ô∏è'][$index % 6] ?>
                            </div>
                            <div class="feature-title">ÌäπÏßï <?= $index + 1 ?></div>
                            <div class="feature-description"><?= htmlspecialchars($feature) ?></div>
                        </div>
                        <?php endforeach; ?>
                    </div>
                    <?php endif; ?>
                </div>

                <!-- Specifications Tab -->
                <div id="specs" class="tab-content">
                    <h3>üìã ÏÉÅÌíàÏ†ïÎ≥¥</h3>
                    <div class="specifications">
                        <ul class="spec-list">
                            <li>
                                <span class="spec-label">ÏÉÅÌíàÎ™Ö</span>
                                <span class="spec-value"><?= htmlspecialchars($product['name']) ?></span>
                            </li>
                            <li>
                                <span class="spec-label">Ïπ¥ÌÖåÍ≥†Î¶¨</span>
                                <span class="spec-value"><?= htmlspecialchars($product['category_name'] ?? 'ÏùºÎ∞ò') ?></span>
                            </li>
                            <?php if (!empty($product['weight'])): ?>
                            <li>
                                <span class="spec-label">Ï§ëÎüâ</span>
                                <span class="spec-value"><?= htmlspecialchars($product['weight']) ?></span>
                            </li>
                            <?php endif; ?>
                            <?php if (!empty($product['dimensions'])): ?>
                            <li>
                                <span class="spec-label">ÌÅ¨Í∏∞</span>
                                <span class="spec-value"><?= htmlspecialchars($product['dimensions']) ?></span>
                            </li>
                            <?php endif; ?>
                            <li>
                                <span class="spec-label">Ïû¨Í≥†ÏàòÎüâ</span>
                                <span class="spec-value"><?= $product['stock_quantity'] ?? 0 ?>Í∞ú</span>
                            </li>
                            <li>
                                <span class="spec-label">Îì±Î°ùÏùº</span>
                                <span class="spec-value"><?= date('Y.m.d', strtotime($product['created_at'] ?? 'now')) ?></span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Reviews Tab -->
                <div id="reviews" class="tab-content">
                    <h3>‚≠ê Î¶¨Î∑∞ (<?= $product['review_count'] ?? 0 ?>Í∞ú)</h3>
                    <p>Î¶¨Î∑∞ ÏãúÏä§ÌÖúÏùÄ Í≥ß Ï∂îÍ∞ÄÎê† ÏòàÏ†ïÏûÖÎãàÎã§.</p>
                </div>

                <!-- Q&A Tab -->
                <div id="qna" class="tab-content">
                    <h3>‚ùì ÏÉÅÌíàÎ¨∏Ïùò</h3>
                    <p>ÏÉÅÌíàÏóê ÎåÄÌïú Î¨∏ÏùòÏÇ¨Ìï≠Ïù¥ ÏûàÏúºÏãúÎ©¥ <a href="/pages/support/contact.php">Í≥†Í∞ùÏÑºÌÑ∞</a>Î°ú Ïó∞ÎùΩÌï¥ Ï£ºÏÑ∏Ïöî.</p>
                </div>
        </div>

        <div class="container">
            <!-- Related Products -->
            <?php if (!empty($relatedProducts)): ?>
            <div class="related-products">
                <div class="related-header">
                    <h3>üîó Í¥ÄÎ†® ÏÉÅÌíà</h3>
                </div>
                <div class="related-grid">
                    <?php foreach ($relatedProducts as $relatedProduct): ?>
                    <a href="/pages/store/product.php?id=<?= $relatedProduct['id'] ?>" class="related-product">
                        <?php
                        $relatedImageSrc = !empty($relatedProduct['image_url'])
                            ? $relatedProduct['image_url']
                            : '/assets/images/product-placeholder.jpg';
                        ?>
                        <img src="<?= htmlspecialchars($relatedImageSrc) ?>"
                             alt="<?= htmlspecialchars($relatedProduct['name']) ?>"
                             class="related-image">
                        <div class="related-info">
                            <h4 class="related-title"><?= htmlspecialchars($relatedProduct['name']) ?></h4>
                            <div class="related-price"><?= number_format($relatedProduct['price']) ?>Ïõê</div>
                            <div class="related-rating">
                                <?= str_repeat('‚≠ê', (int)round($relatedProduct['rating_score'] ?? 4.5)) ?>
                                (<?= $relatedProduct['review_count'] ?? 0 ?>)
                            </div>
                        </div>
                    </a>
                    <?php endforeach; ?>
                </div>
            </div>
            <?php endif; ?>
        </div>
    </main>

    <?php include '../../includes/footer.php'; ?>

    <script src="/assets/js/main.js"></script>
    <style>
        /* Ïª¥Ìå©Ìä∏ ÎîîÏûêÏù∏ - ÏÉÅÌíà Ï†ïÎ≥¥ ÏÑπÏÖò */
        .product-info {
            max-width: 500px;
        }

        .product-header {
            margin-bottom: 8px;
        }

        .product-title {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .product-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            margin-top: 8px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .price-section {
            margin-bottom: 8px;
        }

        .price-wrapper {
            margin-bottom: 10px;
        }

        .current-price {
            font-size: 24px;
        }

        .quantity-shipping-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 8px;
        }

        .shipping-cost-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shipping-label {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .shipping-cost-amount {
            font-size: 14px;
            font-weight: 600;
        }

        .product-description {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .specifications {
            margin-bottom: 0;
        }

        .specifications h4 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .stock-status {
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .quantity-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quantity-label {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }

        .quantity-input {
            width: 60px;
            height: 32px;
            text-align: center;
            font-size: 14px;
        }

        /* Í∞ÄÍ≤© Î∂ÑÌï† ÌëúÏãú Ïä§ÌÉÄÏùº */
        .total-price {
            margin-bottom: 8px;
        }

        .price-breakdown {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
            color: #555;
        }

        .breakdown-item span:first-child {
            font-weight: 500;
        }

        .breakdown-item span:last-child {
            font-weight: 600;
            color: #333;
        }

        .breakdown-divider {
            border-top: 1px solid #dee2e6;
            margin: 8px 0;
        }

        .breakdown-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0 0 0;
            font-size: 16px;
            font-weight: 700;
        }

        .breakdown-total span:first-child {
            color: #333;
        }

        .breakdown-total span:last-child {
            color: #007bff;
            font-size: 18px;
        }

        .total-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons .btn {
            flex: 1;
            padding: 12px;
            font-size: 14px;
        }

        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media (max-width: 768px) {
            /* Product Main - ÏÑ∏Î°ú Î∞∞Ïπò */
            .product-main {
                display: flex !important;
                flex-direction: column !important;
                gap: 20px !important;
            }

            .product-gallery {
                width: 100% !important;
                max-width: 100% !important;
            }

            .product-info {
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Product Tabs - ÎßàÏßÑ Ï∂îÍ∞Ä */
            .product-tabs {
                margin-top: 30px !important;
                clear: both !important;
                position: relative !important;
                z-index: 1 !important;
                background: white !important;
            }

            /* Breadcrumb Î™®Î∞îÏùº Ïä§ÌÉÄÏùº */
            .breadcrumb {
                padding: 12px 0 !important;
                margin-bottom: 20px !important;
                margin-top: 50px !important;
                background: #f8f9fa !important;
                border-bottom: 1px solid #e9ecef !important;
            }

            .breadcrumb .container {
                font-size: 0.75rem !important;
                padding: 0 15px !important;
                line-height: 1.5 !important;
            }

            .breadcrumb .separator {
                margin: 0 6px !important;
            }

            .breadcrumb .current {
                color: #4CAF50 !important;
                font-weight: 600 !important;
            }

            /* Ïû¨Í≥† ÏÉÅÌÉú */
            .stock-status {
                padding: 10px 12px !important;
                margin-bottom: 12px !important;
                font-size: 0.85rem !important;
                font-weight: 600 !important;
                text-align: center !important;
            }

            /* Ï¥ù Í∏àÏï° Î†àÏù¥Î∏î */
            .total-label {
                font-size: 0.95rem !important;
                font-weight: 700 !important;
                margin-bottom: 8px !important;
                text-align: center !important;
            }

            /* Í∞ÄÍ≤© Î∂ÑÌï† ÌëúÏãú */
            .price-breakdown {
                padding: 15px !important;
                margin-top: 10px !important;
            }

            .breakdown-item {
                padding: 8px 0 !important;
                font-size: 0.85rem !important;
            }

            .breakdown-total {
                padding: 10px 0 0 0 !important;
                font-size: 1rem !important;
            }

            .breakdown-total span:last-child {
                font-size: 1.2rem !important;
            }

            /* ÏÉÅÏÑ∏ ÏÑ§Î™Ö ÏΩòÌÖêÏ∏† */
            .product-description-content {
                padding: 15px !important;
                max-height: 600px !important;
                overflow-y: auto !important;
                border: 1px solid #e9ecef !important;
                border-radius: 8px !important;
            }

            .product-description-content img {
                max-width: 100% !important;
                height: auto !important;
                margin: 10px 0 !important;
            }

            .text-align-center {
                text-align: center !important;
                margin: 15px 0 !important;
                padding: 10px !important;
            }
        }
    </style>
    <script>
        // Image gallery functionality
        function changeMainImage(imageSrc, thumbnailElement) {
            document.getElementById('mainImage').src = imageSrc;

            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
            thumbnailElement.classList.add('active');
        }

        // Quantity controls
        function changeQuantity(delta) {
            const input = document.getElementById('quantityInput');
            const currentValue = parseInt(input.value);
            const newValue = currentValue + delta;
            const maxValue = parseInt(input.max);

            if (newValue >= 1 && newValue <= maxValue) {
                input.value = newValue;
                updateTotalPrice();
            }

            // Update button states
            document.getElementById('decreaseBtn').disabled = newValue <= 1;
            document.getElementById('increaseBtn').disabled = newValue >= maxValue;
        }

        function updateTotalPrice() {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            const unitPrice = <?= $finalPrice ?>;
            const baseShippingCost = <?= $shippingCost ?>;
            const shippingUnitCount = <?= $product['shipping_unit_count'] ?? 1 ?>;

            // ÏÉÅÌíà Í∏àÏï° Í≥ÑÏÇ∞
            const productTotal = quantity * unitPrice;

            // Î∞∞ÏÜ°ÎπÑ Í≥ÑÏÇ∞ (shipping_unit_count Í∏∞Ï§Ä)
            let calculatedShippingCost = 0;
            if (baseShippingCost > 0 && shippingUnitCount > 0) {
                const shippingTimes = Math.ceil(quantity / shippingUnitCount);
                calculatedShippingCost = baseShippingCost * shippingTimes;
            }

            // Ï¥ù Í∏àÏï°
            const totalPrice = productTotal + calculatedShippingCost;

            // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('productAmount').textContent = productTotal.toLocaleString() + 'Ïõê';

            if (baseShippingCost > 0) {
                const shippingTimes = Math.ceil(quantity / shippingUnitCount);
                document.getElementById('shippingAmount').textContent =
                    calculatedShippingCost.toLocaleString() + 'Ïõê (' + shippingTimes + 'Ìöå)';
            } else {
                document.getElementById('shippingAmount').textContent = 'Î¨¥Î£å';
            }

            document.getElementById('totalAmount').textContent = totalPrice.toLocaleString() + 'Ïõê';
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Purchase actions
        function addToCart() {
            const quantityInput = document.getElementById('quantityInput');
            const quantity = parseInt(quantityInput ? quantityInput.value : 1) || 1;
            const productId = <?= $product['id'] ?>;

            console.log('Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞Ä ÏãúÏûë - ÏÉÅÌíà ID:', productId, 'ÏàòÎüâ:', quantity);

            // ÏàòÎüâ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (quantity < 1) {
                alert('ÏàòÎüâÏùÄ 1Í∞ú Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }

            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Î∞è Î°úÎî© ÌëúÏãú
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Ï∂îÍ∞Ä Ï§ë...';
            button.disabled = true;

            // AJAXÎ°ú Ïû•Î∞îÍµ¨ÎãàÏóê Ï∂îÍ∞Ä
            fetch('/api/cart.php?action=add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: quantity
                })
            })
            .then(response => {
                console.log('ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                console.log('ÏùëÎãµ Ìó§Îçî:', response.headers);

                // 400 ÏóêÎü¨ÎèÑ JSONÏúºÎ°ú ÌååÏã± (Î°úÍ∑∏Ïù∏ ÌïÑÏöî Îì±Ïùò Í≤ΩÏö∞)
                return response.json();
            })
            .then(data => {
                console.log('ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', data);

                if (data.success) {
                    button.textContent = 'ÏôÑÎ£å!';

                    // ÏÉÅÏÑ∏Ìïú ÏÑ±Í≥µ Î©îÏãúÏßÄ - API ÏùëÎãµ Íµ¨Ï°∞Ïóê ÎßûÍ≤å ÏàòÏ†ï
                    const totalItems = data.data?.cart?.item_count || data.data?.item_count || data.cart?.item_count || '?';
                    const totalAmount = data.data?.cart?.final_total || data.data?.final_total || data.cart?.final_total;
                    const formattedAmount = totalAmount ? new Intl.NumberFormat('ko-KR').format(totalAmount) : '?';

                    alert(`Ïû•Î∞îÍµ¨ÎãàÏóê ${quantity}Í∞úÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!\nÏ¥ù ${totalItems}Í∞ú ÏÉÅÌíà (${formattedAmount}Ïõê)`);

                    // ÏàòÎüâ ÏûÖÎ†•ÎûÄ Ï¥àÍ∏∞Ìôî
                    if (quantityInput) {
                        quantityInput.value = 1;
                    }

                    // Ïû•Î∞îÍµ¨Îãà Ïπ¥Ïö¥Ìä∏ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    const cartCountElement = document.querySelector('.cart-count');
                    if (cartCountElement && totalItems !== '?') {
                        cartCountElement.textContent = totalItems;
                        cartCountElement.style.animation = 'pulse 0.5s ease-in-out';
                    }

                    // Ï†ÑÏó≠ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò Ìò∏Ï∂ú
                    if (typeof window.updateCartCount === 'function') {
                        window.updateCartCount();
                    }

                    // Ïû¨Í≥† Ï†ïÎ≥¥ Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    updateProductStock();

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 1500);
                } else {
                    button.textContent = originalText;
                    button.disabled = false;

                    // Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í≤ΩÏö∞ ÌåùÏóÖ ÌëúÏãú
                    if (data.require_login) {
                        if (confirm(data.message + '\nÎ°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                            // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÎ•º Í∏∞ÏñµÌïòÍ≥† Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                            window.location.href = '/pages/auth/login.php?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
                        }
                    } else {
                        alert('Ïò§Î•ò: ' + (data.message || 'Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§'));
                    }
                }
            })
            .catch(error => {
                console.error('Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                button.textContent = originalText;
                button.disabled = false;

                let errorMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                if (error.message.includes('HTTP')) {
                    errorMessage = 'API Ìò∏Ï∂ú Ïã§Ìå®: ' + error.message + '\nÎ°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï† Ïàò ÏûàÏäµÎãàÎã§.';
                }
                alert(errorMessage);
            });
        }

        function buyNow() {
            const quantity = document.getElementById('quantityInput').value;
            alert(`${quantity}Í∞ú Î∞îÎ°úÍµ¨Îß§ Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.`);
            // TODO: Implement actual purchase functionality
        }

        // ÏÑúÎ≤ÑÏóêÏÑú ÌòÑÏû¨ Ïû¨Í≥† Ï†ïÎ≥¥ Ï°∞ÌöåÌïòÏó¨ ÏóÖÎç∞Ïù¥Ìä∏
        async function updateProductStock() {
            const productId = <?= $product['id'] ?>;

            try {
                const response = await fetch(`/api/product_stock.php?id=${productId}`);
                const data = await response.json();

                if (data.success && data.stock !== undefined) {
                    updateStockDisplay(data.stock);
                } else {
                    console.error('Ïû¨Í≥† Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', data.message);
                }
            } catch (error) {
                console.error('Ïû¨Í≥† Ï†ïÎ≥¥ Ï°∞Ìöå Ïò§Î•ò:', error);
            }
        }

        // Ïû¨Í≥† ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateStockDisplay(currentStock) {
            const stockStatus = document.getElementById('stockStatus');
            const quantityInput = document.getElementById('quantityInput');
            const increaseBtn = document.getElementById('increaseBtn');
            const addCartBtn = document.querySelector('button[onclick*="addToCart"]');
            const buyNowBtn = document.querySelector('button[onclick*="buyNow"]');

            if (!stockStatus) return;

            // Ïû¨Í≥† ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Î∞è Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
            stockStatus.setAttribute('data-stock', currentStock);

            if (currentStock > 10) {
                stockStatus.className = 'stock-status in-stock';
                stockStatus.innerHTML = `‚úÖ Ïû¨Í≥† Ï∂©Î∂Ñ (${currentStock}Í∞ú ÎÇ®Ïùå)`;
            } else if (currentStock > 0) {
                stockStatus.className = 'stock-status low-stock';
                stockStatus.innerHTML = `‚ö†Ô∏è Ïû¨Í≥† Î∂ÄÏ°± (${currentStock}Í∞ú ÎÇ®Ïùå)`;
            } else {
                stockStatus.className = 'stock-status out-of-stock';
                stockStatus.innerHTML = '‚ùå ÌíàÏ†à';
            }

            // ÏàòÎüâ ÏûÖÎ†• ÌïÑÎìú ÏµúÎåÄÍ∞í ÏóÖÎç∞Ïù¥Ìä∏
            if (quantityInput) {
                quantityInput.max = currentStock;

                // ÌòÑÏû¨ ÏûÖÎ†•Îêú ÏàòÎüâÏù¥ Ïû¨Í≥†Î≥¥Îã§ ÎßéÏúºÎ©¥ Ï°∞Ï†ï
                if (parseInt(quantityInput.value) > currentStock) {
                    quantityInput.value = currentStock > 0 ? currentStock : 1;
                }
            }

            // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            if (currentStock <= 0) {
                if (addCartBtn) {
                    addCartBtn.disabled = true;
                    addCartBtn.textContent = 'ÌíàÏ†àÎêú ÏÉÅÌíàÏûÖÎãàÎã§';
                }
                if (buyNowBtn) {
                    buyNowBtn.disabled = true;
                    buyNowBtn.textContent = 'ÌíàÏ†àÎêú ÏÉÅÌíàÏûÖÎãàÎã§';
                }
                if (increaseBtn) {
                    increaseBtn.disabled = true;
                }
            } else {
                if (addCartBtn) {
                    addCartBtn.disabled = false;
                    addCartBtn.textContent = 'üõí Ïû•Î∞îÍµ¨Îãà';
                }
                if (buyNowBtn) {
                    buyNowBtn.disabled = false;
                    buyNowBtn.textContent = 'üí≥ Î∞îÎ°úÍµ¨Îß§';
                }
                if (increaseBtn) {
                    increaseBtn.disabled = false;
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Ï¥àÍ∏∞ Ïû¨Í≥† ÏÉÅÌÉú ÌëúÏãú
            const initialStock = <?= $stockQuantity ?>;
            updateStockDisplay(initialStock);

            updateTotalPrice();

            // Set up quantity input change handler
            document.getElementById('quantityInput').addEventListener('change', function() {
                const value = parseInt(this.value);
                const max = parseInt(this.max);

                if (value < 1) this.value = 1;
                if (value > max) this.value = max;

                updateTotalPrice();
            });
        });
    </script>
</body>
</html>