<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMESTAMP ì˜¤ë¥˜ ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ• TIMESTAMP ì˜¤ë¥˜ ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸</h1>

    <div class="test-section">
        <h2>í˜„ì¬ ë¸Œë¼ìš°ì € í™˜ê²½</h2>
        <p><strong>í˜„ì¬ ì‹œê°„:</strong> <span id="currentTime"></span></p>
        <p><strong>íƒ€ì„ì¡´:</strong> <span id="timeZone"></span></p>
        <p><strong>ë¸Œë¼ìš°ì €:</strong> <span id="browserInfo"></span></p>
    </div>

    <div class="test-section">
        <h2>API íƒ€ì„ìŠ¤íƒ¬í”„ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testAPITimestamp()">API íƒ€ì„ìŠ¤íƒ¬í”„ í™•ì¸</button>
        <div id="apiResult"></div>
    </div>

    <div class="test-section">
        <h2>ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ íƒ€ì„ìŠ¤íƒ¬í”„ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testCartWithTimestamp()">ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ + íƒ€ì„ìŠ¤íƒ¬í”„</button>
        <div id="cartResult"></div>
    </div>

    <div class="test-section">
        <h2>ì˜¤ë¥˜ ë¡œê·¸</h2>
        <div id="errorLog"></div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œì‹œ í™˜ê²½ ì •ë³´ í‘œì‹œ
        window.onload = function() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString();
            document.getElementById('timeZone').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
            document.getElementById('browserInfo').textContent = navigator.userAgent;
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type;
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
        }

        function logError(message, error) {
            const errorElement = document.getElementById('errorLog');
            const timestamp = new Date().toLocaleTimeString();

            let errorDetails = '';
            if (error) {
                errorDetails = `
                    <br>ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message}
                    <br>ì˜¤ë¥˜ íƒ€ì…: ${error.name}
                    <br>ìŠ¤íƒ: ${error.stack}
                `;
            }

            errorElement.innerHTML += `
                <div style="border: 1px solid red; padding: 10px; margin: 5px 0; background: #ffe6e6;">
                    <strong>[${timestamp}] ${message}</strong>
                    ${errorDetails}
                </div>
            `;
        }

        async function testAPITimestamp() {
            document.getElementById('apiResult').innerHTML = '';

            try {
                log('apiResult', 'API íƒ€ì„ìŠ¤íƒ¬í”„ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');

                const response = await fetch('/api/cart.php?action=count');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                log('apiResult', `âœ… API ì‘ë‹µ ì„±ê³µ`, 'success');
                log('apiResult', `íƒ€ì„ìŠ¤íƒ¬í”„: ${data.timestamp}`, 'info');
                log('apiResult', `ì¹´ìš´íŠ¸: ${data.count}`, 'info');

                // íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹± í…ŒìŠ¤íŠ¸
                try {
                    const parsedDate = new Date(data.timestamp);
                    log('apiResult', `âœ… íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹± ì„±ê³µ: ${parsedDate.toLocaleString()}`, 'success');
                } catch (parseError) {
                    log('apiResult', `âŒ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹± ì‹¤íŒ¨: ${parseError.message}`, 'error');
                    logError('íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹± ì˜¤ë¥˜', parseError);
                }

            } catch (error) {
                log('apiResult', `âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                logError('API íƒ€ì„ìŠ¤íƒ¬í”„ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', error);
            }
        }

        async function testCartWithTimestamp() {
            document.getElementById('cartResult').innerHTML = '';

            try {
                log('cartResult', 'ì¥ë°”êµ¬ë‹ˆ íƒ€ì„ìŠ¤íƒ¬í”„ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');

                // 1. ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ì¶”ê°€
                const addResponse = await fetch('/api/cart.php?action=add&product_id=1&quantity=1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_id: 1,
                        quantity: 1
                    })
                });

                if (!addResponse.ok) {
                    const errorText = await addResponse.text();
                    throw new Error(`HTTP ${addResponse.status}: ${errorText}`);
                }

                const addData = await addResponse.json();

                log('cartResult', `âœ… ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì„±ê³µ`, 'success');
                log('cartResult', `ì¶”ê°€ íƒ€ì„ìŠ¤íƒ¬í”„: ${addData.timestamp}`, 'info');

                // 2. ì¥ë°”êµ¬ë‹ˆ ë‚´ìš© ì¡°íšŒ
                const itemsResponse = await fetch('/api/cart.php?action=items');
                const itemsData = await itemsResponse.json();

                log('cartResult', `âœ… ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ ì„±ê³µ`, 'success');
                log('cartResult', `ì¡°íšŒ íƒ€ì„ìŠ¤íƒ¬í”„: ${itemsData.timestamp}`, 'info');
                log('cartResult', `ìƒí’ˆ ìˆ˜: ${Object.keys(itemsData.data).length}ê°œ`, 'info');

                // íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦
                const timestamps = [addData.timestamp, itemsData.timestamp];
                timestamps.forEach((ts, index) => {
                    try {
                        const date = new Date(ts);
                        if (isNaN(date.getTime())) {
                            throw new Error('Invalid date');
                        }
                        log('cartResult', `âœ… íƒ€ì„ìŠ¤íƒ¬í”„ ${index + 1} ìœ íš¨: ${date.toLocaleString()}`, 'success');
                    } catch (parseError) {
                        log('cartResult', `âŒ íƒ€ì„ìŠ¤íƒ¬í”„ ${index + 1} ë¬´íš¨: ${ts}`, 'error');
                        logError(`íƒ€ì„ìŠ¤íƒ¬í”„ ${index + 1} ê²€ì¦ ì˜¤ë¥˜`, parseError);
                    }
                });

            } catch (error) {
                log('cartResult', `âŒ ì¥ë°”êµ¬ë‹ˆ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                logError('ì¥ë°”êµ¬ë‹ˆ íƒ€ì„ìŠ¤íƒ¬í”„ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', error);

                // TIMESTAMP ê´€ë ¨ ì˜¤ë¥˜ì¸ì§€ í™•ì¸
                if (error.message.toLowerCase().includes('timestamp')) {
                    log('cartResult', `ğŸ” TIMESTAMP ê´€ë ¨ ì˜¤ë¥˜ ê°ì§€!`, 'error');
                }
            }
        }

        // ì „ì—­ ì˜¤ë¥˜ í•¸ë“¤ëŸ¬
        window.onerror = function(message, source, lineno, colno, error) {
            logError(`ì „ì—­ JavaScript ì˜¤ë¥˜: ${message} (${source}:${lineno})`, error);
            return false;
        };

        // Promise ê±°ë¶€ í•¸ë“¤ëŸ¬
        window.addEventListener('unhandledrejection', function(event) {
            logError('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€', event.reason);
        });
    </script>
</body>
</html>